<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./qrcode.js"></script>
    <title>Участников:</title>
    <style>
        *{
            box-sizing:border-box;
        }
        @font-face{
            font-family:'Proxima';
            src:url('./proxima.ttf');
        }
        @font-face{
            font-family:'Montserrat';
            src:url('./montserrat.ttf');
        }
        body{
            margin:0;
            padding:0;
            font-family:'Proxima';
        }
        :focus{
            outline:none;
        }
        h1,h2,h3,h4,h5{
            font-family:'ProximaD';
        }
        p{
            margin:0;
        }
        header{
            width:100%;
            padding:20px;
        }
        .logo{
            width:50px;
            height:50px;
        }
        .logo img{
            width:50px;
            height:50px;
        }
        .players-count{
            font-size:3em;
            color:#7373ea;
            
            text-align:center;
        }
        .startgame button{
            border:none;
            border-radius:10px;
            background:#7373ea;
            padding:10px;
            color:white;
            font-family:'Proxima';
            margin-top:11px;
            font-size:1em;
        }
        .startgame p{
            text-align:center;
        }
        .startgame{
            width:fit-content;
            height:auto;
            margin:auto;
        }
        div[data-option="quit"] .leave, button[data-option="deleteroom"]{
border-radius:10px;
color:white;
font-size:1.1em;
border:none;
padding:12px 10px;
font-family:'Proxima';
        }
        div[data-option="quit"]{
            width:fit-content;
            height:auto;
            margin:auto;
        }
        div[data-option="quit"] .leave svg, button[data-option="deleteroom"] svg, .startgame button svg{
            width:25px;
            height:25px;
        }
        .startgame button svg{
            vertical-align: -0.5em;
            margin-left:3px;
        }
        div[data-option="quit"] .leave svg, button[data-option="deleteroom"] svg{
            vertical-align: bottom;
        }
        div[data-option="quit"] .leave{
            background:#7373ea;
        }
        button[data-option="deleteroom"]{
            background:#f34949;
            margin-left:10px;
        }
        .countdown{
            font-size:1.7em;
            text-align:center;
            margin-top:-5px;
            
    font-family: 'Montserrat';
            margin-bottom: 3px;
        }
        .qrcode{
            width: 80vw;
    border-radius: 25px;
    padding: 17px;
    height: auto;
    left: 10vw;
    position: fixed;
    top: 12vh;
    background: white;
        }
        .qrcode #qrcode{
            width: fit-content;
    height: fit-content;
    margin: auto;
            margin-top:15px;
        }
        .qr_bg{
            background:rgba(0,0,0,0.35);
            width:100vw;
            height:100vh;
            position:fixed;
            top:0;
            left:0;
        }
        .qrcode #qrcode img{
            width: 53vw;
        }
        .qrcode p{
            font-size: 1.05em;
    color: #565656;
    margin: 0 5vw;
    margin-top: 20px;
        }
        
        .qrcode_container{
            display:none;
        }
        
        .qr_btn_container{
            width:fit-content;
            height:auto;
            margin:auto;
            margin-top:6px;
        }
.qr_btn_container button{
    border:none;
            border-radius:10px;
            background:#7373ea;
            padding:10px;
            color:white;
            font-family:'Proxima';
            margin-top:11px;
            font-size:1em;
}

.qr_btn_container button svg{
width:25px;
height:25px;
vertical-align:-0.4em;
margin-left:5px;
}
.qrcode_close{
            width:fit-content;
            height:auto;
            margin:auto;
            margin-top:6px;
        }
        .qrcode_close button{
    border:none;
            border-radius:10px;
            background:#7373ea;
            padding:10px;
            color:white;
            font-family:'Proxima';
            margin-top:11px;
            font-size:1em;
}
.qrcode_close button svg{
width:25px;
height:25px;
vertical-align:-0.45em;
margin-left:2px;
}
        </style>
</head>
<body>
    <!--<header>
        <div class="logo">
            <img src="l.png">
        </div>
    </header>-->
    <div class="qrcode_container"><div class="qr_bg"></div>
        
    <div class="qrcode">
        <div id="qrcode">
        </div>
        <p>Покажи этот QR-код другу.<br>Попроси его зайти на главную страницу и нажать на кнопку "Подключиться через QR". Далее ему следует просканировать QR-код с экрана вашего смартфона.</p>
  <div class="qrcode_close"><button>Закрыть<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="times" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512" class="svg-inline--fa fa-times fa-w-11 fa-3x"><path fill="currentColor" d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z" class=""></path></svg></button></div>
  </div>
    </div>
    <p class="players-count"><span data-option="playersCount1"></span>/<span data-option="playersCount2"></span></p>
    
    <p class="countdown">Ждём всех...</p>
    <div class="startgame"></div>
    <p class="username"></p>
    <p class="nosuchroom"></p>
    <p data-option="mode"></p>
    <div class="users"></div>
    <div data-option="quit">
        <a href="/"><button class="leave"><svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path fill="#FFFFFF" d="M13.8,15.3c0.4,0.4,0.4,1,0,1.4c-0.4,0.4-1,0.4-1.4,0c0,0,0,0,0,0l-4-4c-0.4-0.4-0.4-1,0-1.4c0,0,0,0,0,0l4-4c0.4-0.4,1-0.4,1.4,0c0.4,0.4,0.4,1,0,1.4L11.5,11H22c-0.6-5.5-5.5-9.5-10.9-8.9C5.6,2.6,1.5,7.5,2.1,13c0.6,5.5,5.5,9.5,10.9,8.9c4.7-0.5,8.5-4.2,8.9-8.9H11.5L13.8,15.3z"/></svg></button></a></div>
            <div class="qr_btn_container"><button>Показать QR<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path fill="white" d="M8,21H4c-0.6,0-1-0.4-1-1v-4c0-0.6-0.4-1-1-1s-1,0.4-1,1v4c0,1.7,1.3,3,3,3h4c0.6,0,1-0.4,1-1S8.6,21,8,21z M22,15c-0.6,0-1,0.4-1,1v4c0,0.6-0.4,1-1,1h-4c-0.6,0-1,0.4-1,1s0.4,1,1,1h4c1.7,0,3-1.3,3-3v-4C23,15.4,22.6,15,22,15z M20,1h-4c-0.6,0-1,0.4-1,1s0.4,1,1,1h4c0.6,0,1,0.4,1,1v4c0,0.6,0.4,1,1,1h0c0.6,0,1-0.4,1-1V4C23,2.3,21.7,1,20,1z M2,9L2,9c0.6,0,1-0.4,1-1V4c0-0.6,0.4-1,1-1h4c0.6,0,1-0.4,1-1S8.6,1,8,1H4C2.3,1,1,2.3,1,4v4C1,8.6,1.4,9,2,9z M10,5H6C5.4,5,5,5.4,5,6v4c0,0.6,0.4,1,1,1h4c0.6,0,1-0.4,1-1V6C11,5.4,10.6,5,10,5z M14,11h4c0.6,0,1-0.4,1-1V6c0-0.6-0.4-1-1-1h-4c-0.6,0-1,0.4-1,1v4C13,10.6,13.4,11,14,11z M10,13H6c-0.6,0-1,0.4-1,1v4c0,0.6,0.4,1,1,1h4c0.6,0,1-0.4,1-1v-4C11,13.4,10.6,13,10,13z M14,16L14,16c0.6,0,1-0.4,1-1c0.6,0,1-0.4,1-1s-0.4-1-1-1h-1c-0.6,0-1,0.4-1,1v1C13,15.6,13.4,16,14,16z M18,13c-0.6,0-1,0.4-1,1v3c-0.6,0-1,0.4-1,1s0.4,1,1,1h1c0.6,0,1-0.4,1-1v-4C19,13.4,18.6,13,18,13z M14,17c-0.6,0-1,0.4-1,1s0.4,1,1,1s1-0.4,1-1S14.6,17,14,17z"/></svg></button></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io('/room');
function hasNumbers(string) {
  return /\d/.test(string);
}
        function getParam(parameter) {
    let result = null,
        tmp = [], found = false;
    location.search
        .substr(1)
        .split("&")
        .forEach(function (item) {
          tmp = item.split("=");
          
          if (tmp[0] === parameter) {
              result = decodeURIComponent(tmp[1]);
        found = true;
            }
            
            });
            if(!found){
                return false;
            }
            else{
    return result;
            }
}
let playersMaxCount = 2;
const player = {
    socketId:null,
    name:getParam('name'),
    isCreator:false
}
const roomId = getParam('roomId');
if(!hasNumbers(roomId) && roomId.length == 6){
if(getParam('mode') !== false){
    socket.emit('join room',{roomId: roomId,username:player.name,gameOptions:{mode:getParam('mode'),count:getParam('count')}});
}
else{
socket.emit('join room',{roomId: roomId,username:player.name});
}
    document.querySelector('.username').innerText = player.name;
socket.on('room not exists',(data)=>{
    if(data){
    location.href = '/'
    }
})
socket.on('redirect',(data)=>{
    location.href = '/?error';
})

socket.on('get id',data => {
    player.socketId = data;
})
socket.on('get permissions',data => {
    if(data){
    player.isCreator = true;
    document.querySelector('.startgame').innerHTML = `<p>или</p><button><span style="padding-top: 3px;">Начать сейчас</span><svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path fill="white" d="M18.5,9L8.9,3.5C8.4,3.2,7.8,3,7.2,3C5.3,3,3.8,4.5,3.8,6.4v11.2c0,1.9,1.5,3.4,3.4,3.4c0.6,0,1.2-0.2,1.7-0.5l9.7-5.6c0.5-0.3,0.9-0.7,1.2-1.2C20.7,12.1,20.2,10,18.5,9z"/></svg></button>`;
    document.querySelector('div[data-option="quit"]').innerHTML = `<a href="/"><button class="leave"><svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path fill="#FFFFFF" d="M13.8,15.3c0.4,0.4,0.4,1,0,1.4c-0.4,0.4-1,0.4-1.4,0c0,0,0,0,0,0l-4-4c-0.4-0.4-0.4-1,0-1.4c0,0,0,0,0,0l4-4c0.4-0.4,1-0.4,1.4,0c0.4,0.4,0.4,1,0,1.4L11.5,11H22c-0.6-5.5-5.5-9.5-10.9-8.9C5.6,2.6,1.5,7.5,2.1,13c0.6,5.5,5.5,9.5,10.9,8.9c4.7-0.5,8.5-4.2,8.9-8.9H11.5L13.8,15.3z"/></svg></button></a><button data-option="deleteroom"><svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path fill="white" d="M20,6h-4V5c0-1.7-1.3-3-3-3h-2C9.3,2,8,3.3,8,5v1H4C3.4,6,3,6.4,3,7s0.4,1,1,1h1v11c0,1.7,1.3,3,3,3h8c1.7,0,3-1.3,3-3V8h1c0.6,0,1-0.4,1-1S20.6,6,20,6z M10,5c0-0.6,0.4-1,1-1h2c0.6,0,1,0.4,1,1v1h-4V5z M11,17c0,0.6-0.4,1-1,1s-1-0.4-1-1v-6c0-0.6,0.4-1,1-1s1,0.4,1,1V17z M15,17c0,0.6-0.4,1-1,1s-1-0.4-1-1v-6c0-0.6,0.4-1,1-1s1,0.4,1,1V17z"/></svg></button>`;
        document.querySelector('.startgame button').onclick = ()=>{
            socket.emit('start game',{id:player.socketId,room:roomId});
        }
        document.querySelector('button[data-option="deleteroom"]').onclick = ()=>{
            console.log('qew')
            socket.emit('delete room',{id:player.socketId,room:roomId});
        }}
})
	socket.on('console log',data=>{
	console.log(data);
	})
socket.on("user join",(data)=>{
    alert(`${data} присоединился`)
})
socket.on('roomOptions',(data)=>{
    let curMode = '';
    switch(data.mode){
        case 'basic':
            curMode = 'Прятки';
            break;
        case 'hunter':
            curMode = 'Охотник';
            break;
        case 'flypoint':
            curMode = 'Точка взлёта';
            break;
        case 'knocker':
            curMode = 'Тук-тук!'
            break;
        default:
            curMode = 'Ошибка!';
    }
document.querySelector('p[data-option="mode"]').innerText = curMode;
document.querySelector('span[data-option="playersCount2"]').innerText = data.playersMax;
playersMaxCount = data.playersCount;
})
socket.on('roomUsers',(data)=>{
    document.querySelector('.users').innerHTML = '';
    let ul = document.createElement('ul');
    console.log(data);
    
document.querySelector('span[data-option="playersCount1"]').innerText = data.length;
    data.forEach((user)=>{
        let username = user;
        let item = document.createElement('li');
        item.innerText = username;
        ul.appendChild(item);
    })
    document.querySelector('.users').appendChild(ul);})
    
    socket.on('user left',data => {
        alert(`${data} вышел`);
    })
    socket.on('preparing game',data => {
        if(data){
            socket.emit("go to game",roomId)
        }
    })
    socket.on('game start',data => {
        if(data){
            location.href = '/game?id=' + player.socketId;
        }
    })
    socket.on('countdown',data=>{
        if(data){
        let countdownElem = document.querySelector('.countdown');
        let counter = 7;
        window.gameCountdown = setInterval(function(){
            countdownElem.innerText = `Начинаем через ${counter}...`;
            counter--;
        },1000);
        setTimeout(function(){
            clearInterval(window.gameCountdown);
        },7000)
    }
    })
    socket.on('countdown stopped',data=>{
        if(data){
            clearInterval(window.gameCountdown);
            document.querySelector('.countdown').innerHTML = 'Ждём всех...'
        }
    })
    socket.on('room delete',data=>{
        if(data){
            if(player.isCreator === false){
                location.href='/?deleted'
            }
            else{
                location.href = '/';
            }
        }
    })
    //document.querySelector('#qrcode img').setAttribute('src','https://qr.eletto.dev/'+roomId)
    let qrcode = new QRCode("#qrcode");
    qrcode.makeCode(roomId);
    let qrcontainer = document.querySelector('.qrcode_container');
    document.querySelector('.qr_btn_container button').onclick = function(){

        qrcontainer.style.display = 'block';
    }
    document.querySelector('.qrcode_close').onclick = function(){
        qrcontainer.style.display = 'none';
    }
}
else{
    location.href='/';
}
    </script>
</body>
</html>
